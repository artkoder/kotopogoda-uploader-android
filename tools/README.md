# Tools

Утилиты для подготовки и валидации артефактов проекта.

## gen_models_lock.py

Генератор файла `models.lock.json` для моделей машинного обучения.

### Использование

```bash
python tools/gen_models_lock.py
```

### Переменные окружения

- `MODELS_DIST` — путь к директории с распакованными моделями (по умолчанию: `dist`)
- `MODELS_CONTRACT_VERSION` — версия API контракта (по умолчанию: `v1.4.1`)

### Формат выходного файла

Скрипт создает `dist/models.lock.json` со следующей структурой:

```json
{
  "api_contract_version": "v1.4.1",
  "entries": [
    {
      "id": "zerodcepp_fp16",
      "backend": "ncnn",
      "files": [
        { "path": "models/zerodcepp_fp16.param", "sha256": "..." },
        { "path": "models/zerodcepp_fp16.bin", "sha256": "..." }
      ]
    },
    {
      "id": "restormer_fp16",
      "backend": "ncnn",
      "files": [
        { "path": "models/restormer_fp16.param", "sha256": "..." },
        { "path": "models/restormer_fp16.bin", "sha256": "..." }
      ]
    },
    {
      "id": "metadata",
      "backend": "METADATA",
      "jq_sha256sum": "..."
    }
  ]
}
```

### Требования

- Директория `dist/models/` должна содержать все файлы моделей (`.param`, `.bin`)
- Файл `dist/SHA256SUMS.txt` должен существовать для вычисления метахеша

### Валидация

После генерации файл валидируется следующим образом:

1. Проверка структуры: `entries` должен быть списком
2. Проверка версии контракта: должна быть `v1.4.1`
3. Проверка существования файлов моделей
4. Проверка соответствия SHA-256 хешей
5. Проверка формата `jq_sha256sum` для метаданных

При ошибке валидации скрипт завершится с кодом выхода 2.

### Автоматическое использование в CI

Скрипт автоматически запускается в workflow `prepare_models.yml` и:

1. Генерирует lock-файл из распакованных моделей
2. Валидирует его корректность
3. Синхронизирует в корень репозитория через PR

См. также: `docs/models.lock.sample.json` для примера выходного формата.
