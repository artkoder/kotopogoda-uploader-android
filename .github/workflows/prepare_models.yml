name: Prepare models
on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Бранч или тег, для которого нужно подготовить модели"
        default: main
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies and build NCNN tools
        run: |
          set -euxo pipefail
          sudo apt-get update
          APT_PACKAGES="git-lfs wget unzip ffmpeg libonnx-dev protobuf-compiler libprotobuf-dev cmake ninja-build build-essential lld"
          sudo apt-get install -y ${APT_PACKAGES}

          NCNN_REPO=https://github.com/Tencent/ncnn.git
          NCNN_COMMIT=56775de50990ab7f16627efdcf5529b49541206f
          git clone ${NCNN_REPO} ncnn
          git -C ncnn checkout ${NCNN_COMMIT}
          cmake -S ncnn -B ncnn/build -G Ninja \
            -DNCNN_VULKAN=OFF \
            -DNCNN_BUILD_TOOLS=ON \
            -DNCNN_BUILD_EXAMPLES=OFF \
            -DNCNN_BUILD_BENCHMARK=OFF
          cmake --build ncnn/build --target onnx2ncnn ncnnoptimize
          ls -l ncnn/build/tools
          sudo install -m 0755 ncnn/build/tools/onnx/onnx2ncnn /usr/local/bin/onnx2ncnn
          sudo install -m 0755 ncnn/build/tools/ncnnoptimize /usr/local/bin/ncnnoptimize
          sudo ldconfig
          if ! onnx2ncnn --help >/dev/null 2>&1; then
            echo "onnx2ncnn не поддерживает --help, выполняем холостой запуск"
            onnx2ncnn </dev/null >/dev/null 2>&1 || true
          fi
          if ! ncnnoptimize --help >/dev/null 2>&1; then
            echo "ncnnoptimize не поддерживает --help, выполняем холостой запуск"
            ncnnoptimize </dev/null >/dev/null 2>&1 || true
          fi
          rm -rf ncnn

      - name: Verify NCNN tools availability
        run: |
          set -euxo pipefail
          command -v onnx2ncnn
          onnx2ncnn </dev/null >/dev/null 2>&1 || true
          command -v ncnnoptimize
          ncnnoptimize </dev/null >/dev/null 2>&1 || true

      - name: Install Python dependencies
        run: |
          set -euxo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install \
            "numpy<2" \
            torch torchvision \
            "onnx==1.16.*" "onnxruntime==1.16.*" "onnxsim==0.4.*" onnx-graphsurgeon onnxscript sng4onnx \
            "onnx2tf>=1.24,<1.25" \
            "tensorflow==2.14.1" "keras==2.14.*" "tensorflow-addons==0.23.*" "tensorflow-probability==0.23.*" "onnx-tf==1.10.0" \
            "tf-keras==2.14.*" \
            einops "opencv-python-headless<5" lmdb tqdm pyyaml "scipy<1.14" "scikit-image<0.23" \
            psutil>=5.9 "ml_dtypes<0.5"
          python3 - <<'PY'
          import onnx
          import onnx2tf
          from onnx.serialization import ProtoSerializer

          print("ONNX", onnx.__version__, "OK")
          PY
          python3 - <<'PY'
          import importlib.metadata as metadata
          packages = [
              "numpy",
              "torch",
              "torchvision",
              "onnx",
              "onnxruntime",
              "onnxsim",
              "onnx2tf",
              "tf-keras",
              "onnx-graphsurgeon",
              "tensorflow",
              "keras",
              "tensorflow-addons",
              "onnx-tf",
              "psutil",
              "einops",
              "opencv-python-headless",
              "lmdb",
              "tqdm",
              "pyyaml",
              "scipy",
              "scikit-image",
              "ml_dtypes",
          ]
          for pkg in packages:
              try:
                  version = metadata.version(pkg)
              except metadata.PackageNotFoundError:
                  version = "не установлен"
              print(f"{pkg}: {version}")
          PY
          python3 - <<'PY'
          import onnx
          import onnx2tf
          import onnx_graphsurgeon
          import tf_keras
          import psutil

          print("tf_keras:", tf_keras.__version__)
          print("onnx_graphsurgeon:", onnx_graphsurgeon.__version__)
          print("onnx:", onnx.__version__)
          print("onnx2tf:", onnx2tf.__version__)
          print("psutil:", psutil.__version__)
          PY

      - name: Prepare model artifacts
        env:
          TF_USE_LEGACY_KERAS: "1"
          KERAS_BACKEND: "tensorflow"
        run: |
          set -euxo pipefail
          # Шим совместимости: некоторые версии ml_dtypes в связке с TF/Keras 2.14
          # не содержат новые float8-алиасы, которые импортирует Zero-DCE.
          # sitecustomize.py автоматически импортируется интерпретатором.
          cat > sitecustomize.py <<'PY'
try:
    import ml_dtypes as _m
    import numpy as _np
    # Набор алиасов, которые иногда отсутствуют
    _aliases = (
        "float8_e4m3fn",
        "float8_e4m3fnuz",
        "float8_e5m2",
        "float8_e5m2fnuz",
        "float8_e4m3b11fnuz",
    )
    for _name in _aliases:
        if not hasattr(_m, _name):
            setattr(_m, _name, _np.float16)
except Exception as _e:
    print("sitecustomize: ml_dtypes compat shim skipped:", _e)
PY
          # Небольшая проверка — не обязательна, но полезна в логах
          python3 - <<'PY'
import ml_dtypes as m
print("ml_dtypes present float8 attrs:", [a for a in dir(m) if a.startswith("float8_")])
PY

          bash scripts/prepare_models.sh


      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          bash scripts/publish_models_release.sh
      - name: Create PR with updated model artifacts
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bot/models-release-${{ github.run_id }}
          base: main
          title: "chore(models): update model lock & checksums"
          commit-message: "chore(models): update model lock & checksums"
          body: "Автоматическое обновление артефактов моделей."
          labels: automated, models
          add-paths: |
            models.lock.json
