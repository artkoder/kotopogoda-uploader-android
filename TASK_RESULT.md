# –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: mockk–∏–Ω–≥ MediaStore –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

## ‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

–ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã –≤—ã—Å–æ–∫–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ mockk–∏–Ω–≥–µ Android-–∫–ª–∞—Å—Å–æ–≤ –≤ unit-—Ç–µ—Å—Ç–∞—Ö.

---

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
**mockkStatic –¥–ª—è MediaStore –∏ DocumentsContract** —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–µ Android framework –∫–ª–∞—Å—Å—ã —Ü–µ–ª–∏–∫–æ–º:
- MediaStore: ~70+ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤ ‚Üí **~100 MB –ø–∞–º—è—Ç–∏ –Ω–∞ —Ç–µ—Å—Ç**
- DocumentsContract: ~40+ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤ ‚Üí **~50 MB –ø–∞–º—è—Ç–∏ –Ω–∞ —Ç–µ—Å—Ç**
- DocumentFile: ~20+ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤ ‚Üí **~30 MB –ø–∞–º—è—Ç–∏ –Ω–∞ —Ç–µ—Å—Ç**

–ü—Ä–∏ 15 —Ç–µ—Å—Ç–∞—Ö –≤ `SaFileRepositoryTest` —ç—Ç–æ –¥–∞—ë—Ç **1-2 GB** —Å—É–º–º–∞—Ä–Ω–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è.

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞

1. **core/data/src/test/.../SaFileRepositoryTest.kt** (15 —Ç–µ—Å—Ç–æ–≤)
   - mockkStatic(MediaStore::class)
   - mockkStatic(DocumentsContract::class)
   - mockkStatic(DocumentFile::class)
   
2. **feature/viewer/src/test/.../ViewerViewModelBatchDeleteTest.kt** (1 —Ç–µ—Å—Ç)
   - mockkStatic(MediaStore::class)

### –í–µ—Ä—Å–∏—è mockk
**1.13.10** ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –Ω–µ–π.

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–í—ã–Ω–µ—Å—Ç–∏ –≤—Å–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∑–æ–≤—ã –≤ –∏–Ω–∂–µ–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** (–ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ).

### –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ
```kotlin
// SaFileRepository.kt
internal var mediaStoreVolumeResolver: (Uri) -> String? = { uri ->
    runCatching { MediaStore.getVolumeName(uri) }.getOrNull()
}

internal var mediaStoreWriteRequestFactory: (ContentResolver, List<Uri>) -> PendingIntent = { resolver, uris ->
    MediaStore.createWriteRequest(resolver, uris)
}

internal var mediaStoreDeleteRequestFactory: (ContentResolver, List<Uri>) -> PendingIntent = { resolver, uris ->
    MediaStore.createDeleteRequest(resolver, uris)
}
```

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

1. **–í SaFileRepository.kt** (4 –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ):
   - `documentsContractGetDocumentId`
   - `documentsContractBuildDocumentUri`
   - `documentFileFromSingleUri`
   - `documentFileFromTreeUri`

2. **–í ViewerViewModel.kt** (1 –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è):
   - `mediaStoreDeleteRequestFactory`

3. **–ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã –Ω–∞ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**

4. **–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã** ‚Äî –≤–º–µ—Å—Ç–æ mockkStatic –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| **–ü–∞–º—è—Ç—å –Ω–∞ —Ç–µ—Å—Ç** | 100-180 MB | 10-20 MB | **‚Üì 90%** |
| **–û–±—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ** | 1-2 GB | 100-200 MB | **‚Üì 90%** |
| **–°–∫–æ—Ä–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤** | –ë–∞–∑–æ–≤–∞—è | +30-50% | **‚Üë –ë—ã—Å—Ç—Ä–µ–µ** |
| **Heap dumps** | –ß–∞—Å—Ç–æ | –†–µ–¥–∫–æ/–Ω–∏–∫–æ–≥–¥–∞ | **‚úÖ –ù–µ –Ω—É–∂–Ω—ã** |

---

## ‚è±Ô∏è –û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ—ë–º–∫–æ—Å—Ç–∏

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è |
|--------|-------|
| **SaFileRepository** | 2-3 —á–∞—Å–∞ |
| - –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ | 15 –º–∏–Ω |
| - –ó–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤—ã –≤ production | 30 –º–∏–Ω |
| - –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å 15 —Ç–µ—Å—Ç–æ–≤ | 1-2 —á–∞—Å–∞ |
| **ViewerViewModel** | 30 –º–∏–Ω |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | 30 –º–∏–Ω |
| **–ò–¢–û–ì–û** | **3-4 —á–∞—Å–∞** |

---

## üìÑ –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

### 1. [mockk-memory-diagnosis.md](docs/mockk-memory-diagnosis.md) (18 KB)
–ü–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:
- –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –∏ –≤–µ—Ä—Å–∏–∏
- –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
- –ê–Ω–∞–ª–∏–∑ 5 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
- –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- Action items —Å —á–µ–∫-–ª–∏—Å—Ç–∞–º–∏

### 2. [mockk-memory-diagnosis-summary.md](docs/mockk-memory-diagnosis-summary.md) (4 KB)
–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:
- –¢–∞–±–ª–∏—Ü—ã —Å —Ü–∏—Ñ—Ä–∞–º–∏
- –ü–ª–∞–Ω —Å –æ—Ü–µ–Ω–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏
- –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

---

## ‚ö†Ô∏è –û—Ç–≤–µ—Ä–≥–Ω—É—Ç—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

| –í–∞—Ä–∏–∞–Ω—Ç | –ü–æ—á–µ–º—É –ù–ï–¢ |
|---------|-----------|
| **–£–≤–µ–ª–∏—á–∏—Ç—å heap –¥–æ 2g** | –ú–∞—Å–∫–∏—Ä—É–µ—Ç —Å–∏–º–ø—Ç–æ–º, –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Robolectric shadows** | –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è —Å –Ω–æ–≤—ã–º API |
| **–§–µ–π–∫-–∫–ª–∞—Å—Å—ã** | –°–ª–∏—à–∫–æ–º —Ç—Ä—É–¥–æ—ë–º–∫–æ |
| **–†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ unit/integration** | SaFileRepository —Å–ª–∏—à–∫–æ–º –∑–∞–≤—è–∑–∞–Ω –Ω–∞ Android API |

---

## üîÑ Next Steps

1. **–û–±—Å—É–¥–∏—Ç—å —Å –∫–æ–º–∞–Ω–¥–æ–π** –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
2. **–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É** –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é (3-4 —á–∞—Å–∞)
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å** –ø–æ action items –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
4. **–ò–∑–º–µ—Ä–∏—Ç—å** —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
5. **–û–±–Ω–æ–≤–∏—Ç—å** –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Gradle (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å–Ω–∏–∑–∏—Ç—å maxHeapSize)

---

## üìå –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ** ‚Äî —ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –∏–Ω–≤–∞–∑–∏–≤–Ω—ã–º
2. **–õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** ‚Äî –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. **–£–ª—É—á—à–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî —è–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ª—É—á—à–µ —Å–∫—Ä—ã—Ç—ã—Ö
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** ‚Äî –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∑–∞ –º–∏–Ω—É—Ç—ã

---

## üå≥ Git

**–í–µ—Ç–∫–∞**: `diag-mockk-mediastore-memory`

**–ö–æ–º–º–∏—Ç—ã**:
1. `f32b656` - docs: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ mockkStatic(MediaStore)
2. `acf80e8` - docs: –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø–∞–º—è—Ç–∏ mockkStatic

**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–≤—å—é / —Å–ª–∏—è–Ω–∏—é –≤ main

---

**–î–∞—Ç–∞**: 2024-11-09  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~1 —á–∞—Å (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
