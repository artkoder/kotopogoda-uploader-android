# –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞: –ü—Ä–æ–±–ª–µ–º–∞ –ø–∞–º—è—Ç–∏ —Å mockkStatic(MediaStore)

## üéØ –í–µ—Ä–¥–∏–∫—Ç

**–ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å heap, –∞ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç—ã.**

## üìä –¶–∏—Ñ—Ä—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| –ü–∞–º—è—Ç—å –Ω–∞ —Ç–µ—Å—Ç | 100-180 MB | 10-20 MB | **90%** ‚Üì |
| –û–±—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (15 —Ç–µ—Å—Ç–æ–≤) | 1-2 GB | 100-200 MB | **90%** ‚Üì |
| –°–∫–æ—Ä–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ | –ë–∞–∑–æ–≤–∞—è | +30-50% | **–ë—ã—Å—Ç—Ä–µ–µ** |

## üîç –ß—Ç–æ –Ω–∞—à–ª–∏

### SaFileRepositoryTest.kt (15 —Ç–µ—Å—Ç–æ–≤)
```kotlin
mockkStatic(MediaStore::class)           // üî¥ 100 MB
mockkStatic(DocumentsContract::class)    // üî¥ 50 MB  
mockkStatic(DocumentFile::class)         // üî¥ 30 MB
```

### ViewerViewModelBatchDeleteTest.kt (1 —Ç–µ—Å—Ç)
```kotlin
mockkStatic(MediaStore::class)           // üî¥ 100 MB
```

## üí° –†–µ—à–µ–Ω–∏–µ

–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

```kotlin
// ‚úÖ –£–ñ–ï –ï–°–¢–¨ –≤ SaFileRepository.kt
internal var mediaStoreVolumeResolver: (Uri) -> String? = { uri ->
    runCatching { MediaStore.getVolumeName(uri) }.getOrNull()
}
```

**–ù—É–∂–Ω–æ**: –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏ —É–±—Ä–∞—Ç—å mockkStatic.

## üìù –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: SaFileRepository (2-3 —á–∞—Å–∞)

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** (15 –º–∏–Ω—É—Ç):
   ```kotlin
   internal var documentsContractGetDocumentId: (Uri) -> String = { ... }
   internal var documentsContractBuildDocumentUri: (Uri, String) -> Uri = { ... }
   internal var documentFileFromSingleUri: (Context, Uri) -> DocumentFile? = { ... }
   internal var documentFileFromTreeUri: (Context, Uri) -> DocumentFile? = { ... }
   ```

2. **–ó–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤—ã –≤ production** (30 –º–∏–Ω—É—Ç):
   ```kotlin
   // –ë—ã–ª–æ:
   DocumentsContract.getDocumentId(uri)
   
   // –°—Ç–∞–ª–æ:
   documentsContractGetDocumentId(uri)
   ```

3. **–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å 15 —Ç–µ—Å—Ç–æ–≤** (1-2 —á–∞—Å–∞):
   ```kotlin
   // –ë—ã–ª–æ:
   mockkStatic(DocumentsContract::class)
   every { DocumentsContract.getDocumentId(uri) } returns "external:Pictures"
   
   // –°—Ç–∞–ª–æ:
   documentsContractGetDocumentId = { "external:Pictures" }
   ```

4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã**:
   ```bash
   ./gradlew :core:data:testDebugUnitTest
   ```

### –§–∞–∑–∞ 2: ViewerViewModel (30 –º–∏–Ω—É—Ç)

1. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
2. –ó–∞–º–µ–Ω–∏—Ç—å 2 –≤—ã–∑–æ–≤–∞
3. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å 1 —Ç–µ—Å—Ç
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å: `./gradlew :feature:viewer:testDebugUnitTest`

## ‚ö†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è)

| –í–∞—Ä–∏–∞–Ω—Ç | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã | –í–µ—Ä–¥–∏–∫—Ç |
|---------|-------|--------|---------|
| –£–≤–µ–ª–∏—á–∏—Ç—å heap –¥–æ 2g | –ë—ã—Å—Ç—Ä–æ | –ù–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É | ‚ùå |
| Robolectric shadows | –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–µ–µ | –ù—É–∂–Ω–æ —É—á–∏—Ç—å API | ‚ö†Ô∏è |
| –§–µ–π–∫-–∫–ª–∞—Å—Å—ã | –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å | –ú–Ω–æ–≥–æ –∫–æ–¥–∞ | ‚ùå |
| –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã + DI | –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –ú–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π | üîÑ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ |

## ‚úÖ –ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**: –ü–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ
2. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: 90% —Å–Ω–∏–∂–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
3. **–ë—ã—Å—Ç—Ä–æ**: 2-4 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
5. **–£–ª—É—á—à–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**: –Ø–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

## üìö –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑

–°–º. [mockk-memory-diagnosis.md](./mockk-memory-diagnosis.md)

---

**–î–∞—Ç–∞**: 2024  
**–í–µ—Ç–∫–∞**: `diag-mockk-mediastore-memory`
