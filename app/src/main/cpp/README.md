# Native NCNN Enhancement Module

Этот модуль реализует нативную обработку изображений с использованием NCNN и Vulkan для улучшения производительности.

## Архитектура

- **native_enhance_jni.cpp** - JNI точки входа для взаимодействия с Kotlin
- **ncnn_engine.cpp** - Основной движок управления моделями NCNN
- **restormer_backend.cpp** - Бэкенд для модели Restormer
- **zerodce_backend.cpp** - Бэкенд для модели Zero-DCE++
- **tile_processor.cpp** - Тайловая обработка для больших изображений (512x512 с 16px overlap)
- **hann_window.cpp** - Оконная функция Ханна для сглаживания швов
- **sha256_verifier.cpp** - Верификация контрольных сумм моделей

## Требования

- Android NDK 26.1.10909125 или выше
- CMake 3.22.1 или выше
- NCNN библиотека с поддержкой Vulkan

## Установка NCNN

Перед сборкой выполните:

```bash
./scripts/download_ncnn.sh
```

Это скачает предсобранные библиотеки NCNN для Android с поддержкой Vulkan.

## Сборка

Модуль собирается автоматически при сборке приложения через Gradle:

```bash
./gradlew :app:assembleDebug
```

## Поддерживаемые архитектуры

- **arm64-v8a** - Основная архитектура для Android устройств
- **x86_64** - Для эмулятора

## Функции

### Vulkan

Модуль автоматически определяет доступность Vulkan и использует его для ускорения вычислений.
При отсутствии Vulkan используется CPU fallback с ARM NEON оптимизациями.

### Тайловая обработка

Для изображений больше 512x512 используется тайловая обработка:
- Размер тайла: 512x512
- Перекрытие: 16px
- Сглаживание: Окно Ханна
- Многопоточность: 4-8 потоков

### Верификация моделей

При первой загрузке моделей вычисляется SHA256 хеш и сравнивается с ожидаемым значением.
Несоответствия логируются, но не блокируют работу (для совместимости с обновлениями).

## Telemetry

Каждая операция возвращает метрики:
- `timingMs` - Время выполнения в миллисекундах
- `usedVulkan` - Использовался ли Vulkan
- `peakMemoryKb` - Пиковое использование памяти
- `cancelled` - Была ли операция отменена

## Отладка

Логи пишутся в Android logcat с тегами:
- `NativeEnhanceJNI` - JNI операции
- `NcnnEngine` - Работа движка
- `RestormerBackend` - Обработка Restormer
- `ZeroDceBackend` - Обработка Zero-DCE++
- `TileProcessor` - Тайловая обработка
